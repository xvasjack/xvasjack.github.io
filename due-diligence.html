<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Due Diligence Report Generator</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    .dd-container { max-width: 1200px; margin: 0 auto; }

    /* Mode Tabs */
    .dd-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 2px solid var(--border-medium);
    }
    .dd-tab {
      flex: 1;
      padding: 14px 20px;
      border: none;
      background: var(--bg-surface);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .dd-tab:first-child { border-right: 1px solid var(--border-medium); }
    .dd-tab:hover { background: var(--bg-body); }
    .dd-tab.active {
      background: var(--accent);
      color: white;
    }
    .dd-tab svg { width: 20px; height: 20px; }

    /* Mode Content */
    .dd-mode { display: none; }
    .dd-mode.active { display: block; }

    /* Upload Mode */
    .dd-upload-zone {
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-md);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-body);
    }
    .dd-upload-zone:hover, .dd-upload-zone.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .dd-upload-zone svg { width: 48px; height: 48px; color: var(--accent); margin-bottom: 12px; }
    .dd-upload-zone h3 { font-size: 16px; margin: 0 0 4px 0; }
    .dd-upload-zone p { font-size: 13px; color: var(--text-muted); margin: 0; }
    #fileInput { display: none; }

    .dd-file-list { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
    .dd-file-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
    }
    .dd-file-item svg { width: 20px; height: 20px; color: var(--accent); }
    .dd-file-item span { flex: 1; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .dd-file-item button { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 18px; }
    .dd-file-item button:hover { color: var(--error); }

    /* Record Mode - Split Layout */
    .dd-record-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      min-height: 400px;
    }
    @media (max-width: 900px) {
      .dd-record-layout { grid-template-columns: 1fr; }
    }

    /* Recording Controls - Compact */
    .dd-record-controls {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      height: fit-content;
    }
    .dd-record-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid var(--error);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .dd-record-btn:hover { transform: scale(1.05); }
    .dd-record-btn.recording {
      animation: pulse-record 1.5s infinite;
      background: var(--error);
      border-color: var(--error);
    }
    .dd-record-btn svg { width: 28px; height: 28px; color: var(--error); }
    .dd-record-btn.recording svg { color: white; }
    @keyframes pulse-record {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
    }
    .dd-record-timer {
      font-family: monospace;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
    }
    .dd-record-timer.recording { color: var(--error); }
    .dd-record-status {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    .dd-record-status.recording { color: var(--error); font-weight: 600; }

    .dd-lang-select {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }
    .dd-lang-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--bg-body);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }
    .dd-lang-btn:hover { border-color: var(--accent); }
    .dd-lang-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Transcript Panels - Main Focus */
    .dd-transcript-panels {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }
    .dd-transcript-panel {
      flex: 1;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }
    .dd-panel-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dd-panel-header .lang-badge {
      background: var(--accent-soft);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .dd-panel-content {
      flex: 1;
      padding: 16px;
      font-size: 15px;
      line-height: 1.7;
      overflow-y: auto;
      max-height: 300px;
      color: var(--text-main);
    }
    .dd-panel-content.empty {
      color: var(--text-light);
      font-style: italic;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Recovery Banner */
    .dd-recovery-banner {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .dd-recovery-banner p { margin: 0; font-size: 13px; color: #92400e; }
    .dd-recovery-banner strong { color: #78350f; }
    .dd-recovery-actions { display: flex; gap: 8px; }
    .dd-recovery-btn {
      padding: 6px 12px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .dd-recovery-btn.restore { background: #f59e0b; color: white; }
    .dd-recovery-btn.dismiss { background: white; color: #92400e; border: 1px solid #f59e0b; }
    .dd-panel-content .interim { color: var(--text-muted); }
    .dd-transcript-panel.translation { border-left: 3px solid var(--success); }
    .dd-transcript-panel.translation .dd-panel-header { color: var(--success); }

    /* Form Section */
    .dd-form-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-subtle);
    }
    .dd-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 600px) {
      .dd-form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <a href="find-target.html" class="logo">
      <span class="logo-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </span>
      Find Target
    </a>
    <nav>
      <a href="find-target.html">v3 Fast</a>
      <a href="find-target-slow.html">v3 Slow</a>
      <a href="find-target-v4.html">v4 Search</a>
      <a href="validation.html">Validation</a>
      <a href="trading-comparable.html">Trading Comp</a>
      <a href="profile-slides.html">Slides</a>
      <a href="due-diligence.html" class="active">Due Diligence</a>
      <a href="write-like-anil.html">Write Like Anil</a>
      <a href="utb.html">UTB</a>
    </nav>
  </header>

  <main class="app-main">
    <section class="page-info">
      <span class="status-badge">Online</span>
      <h1 class="page-title">Due Diligence Report</h1>
      <p class="page-description">Upload materials or record meetings in real-time. Get both a full DD report and transcript emailed with Word attachment.</p>
    </section>

    <section class="page-content dd-container">
      <!-- Mode Selection Tabs -->
      <div class="dd-tabs">
        <button class="dd-tab active" data-mode="upload">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          Upload Materials
        </button>
        <button class="dd-tab" data-mode="record">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
          Record Now
        </button>
      </div>

      <!-- Upload Mode -->
      <div class="dd-mode active" id="uploadMode">
        <div class="form-card">
          <input type="file" id="fileInput" multiple accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.rtf,.csv,.xlsx,.xls,.mp3,.wav,.m4a,.webm,.ogg">

          <div class="dd-upload-zone" id="uploadZone">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3>Drop files here or click to upload</h3>
            <p>PDF, PPT, Word, Excel, Audio files (max 10 files)</p>
          </div>

          <div class="dd-file-list" id="fileList"></div>

          <div class="dd-form-section">
            <div class="form-group">
              <label for="uploadInstructions">Special Requests <span class="label-hint">(optional)</span></label>
              <textarea id="uploadInstructions" rows="2" placeholder="e.g., Focus on financial risks, highlight synergies..."></textarea>
            </div>

            <div class="dd-form-row">
              <div class="form-group">
                <label for="uploadEmail">Email Address</label>
                <input type="email" id="uploadEmail" required placeholder="your@company.com">
              </div>
              <div class="form-group">
                <label>Report Length</label>
                <select id="uploadLength" style="width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm);">
                  <option value="short">Short (1 page)</option>
                  <option value="medium" selected>Medium (2-3 pages)</option>
                  <option value="long">Full (Comprehensive)</option>
                </select>
              </div>
            </div>

            <button type="button" class="submit-btn" id="uploadSubmitBtn">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Generate DD Report & Transcript
            </button>
          </div>
        </div>
      </div>

      <!-- Record Mode -->
      <div class="dd-mode" id="recordMode">
        <!-- Recovery Banner (hidden by default) -->
        <div class="dd-recovery-banner" id="recoveryBanner" style="display: none;">
          <p><strong>Unsaved recording found!</strong> Your previous session was interrupted.</p>
          <div class="dd-recovery-actions">
            <button class="dd-recovery-btn restore" onclick="restoreSession()">Restore</button>
            <button class="dd-recovery-btn dismiss" onclick="dismissRecovery()">Dismiss</button>
          </div>
        </div>
        <div class="dd-record-layout">
          <!-- Left: Recording Controls -->
          <div class="dd-record-controls">
            <div class="dd-lang-select">
              <button class="dd-lang-btn active" data-lang="auto">Auto</button>
              <button class="dd-lang-btn" data-lang="en">English</button>
              <button class="dd-lang-btn" data-lang="zh">Chinese</button>
              <button class="dd-lang-btn" data-lang="ms">Malay</button>
              <button class="dd-lang-btn" data-lang="ja">Japanese</button>
            </div>

            <button class="dd-record-btn" id="recordBtn">
              <svg fill="currentColor" viewBox="0 0 24 24" id="recordIcon">
                <circle cx="12" cy="12" r="8"/>
              </svg>
            </button>

            <div class="dd-record-timer" id="recordTimer">00:00</div>
            <div class="dd-record-status" id="recordStatus">Click to start recording</div>
            <button type="button" class="dd-download-btn" id="downloadRecordingBtn" style="display: none; padding: 6px 12px; font-size: 11px; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-secondary); cursor: pointer; margin-top: 4px;">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
              Download Recording
            </button>

            <div style="width: 100%; margin-top: auto;">
              <div class="form-group" style="margin: 0;">
                <label for="recordInstructions">Special Requests <span class="label-hint">(optional)</span></label>
                <textarea id="recordInstructions" rows="2" placeholder="e.g., Focus on action items..."></textarea>
              </div>
              <div class="form-group" style="margin: 12px 0 0 0;">
                <label for="recordEmail">Email Address</label>
                <input type="email" id="recordEmail" required placeholder="your@company.com">
              </div>
              <button type="button" class="submit-btn" id="recordSubmitBtn" disabled style="margin-top: 12px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Send DD Report & Transcript
              </button>
            </div>
          </div>

          <!-- Right: Live Transcript -->
          <div class="dd-transcript-panels">
            <div class="dd-transcript-panel">
              <div class="dd-panel-header">
                <span>Live Transcript</span>
                <span class="lang-badge" id="detectedLang">--</span>
              </div>
              <div class="dd-panel-content empty" id="transcriptContent">
                Start recording to see live transcription...
              </div>
            </div>

            <div class="dd-transcript-panel translation" id="translationPanel" style="display: none;">
              <div class="dd-panel-header">
                <span>English Translation</span>
              </div>
              <div class="dd-panel-content" id="translationContent"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="message success" id="successMessage" style="margin-top: 20px;">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <span id="successText">Success!</span>
      </div>
      <div class="message error" id="errorMessage" style="margin-top: 20px;">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        <span id="errorText">Error</span>
      </div>
    </section>
  </main>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const API_BASE = 'https://xvasjackgithubio-production.up.railway.app';
    const WS_BASE = API_BASE.replace('https://', 'wss://').replace('http://', 'ws://');

    // Elements
    const tabs = document.querySelectorAll('.dd-tab');
    const modes = document.querySelectorAll('.dd-mode');
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
    const recordBtn = document.getElementById('recordBtn');
    const recordIcon = document.getElementById('recordIcon');
    const recordTimer = document.getElementById('recordTimer');
    const recordStatus = document.getElementById('recordStatus');
    const downloadRecordingBtn = document.getElementById('downloadRecordingBtn');
    const recordSubmitBtn = document.getElementById('recordSubmitBtn');
    const transcriptContent = document.getElementById('transcriptContent');
    const translationContent = document.getElementById('translationContent');
    const translationPanel = document.getElementById('translationPanel');
    const detectedLang = document.getElementById('detectedLang');
    const langBtns = document.querySelectorAll('.dd-lang-btn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const successText = document.getElementById('successText');
    const errorText = document.getElementById('errorText');

    let selectedFiles = [];
    let selectedLang = 'auto';
    let isRecording = false;
    let mediaRecorder = null;
    let audioContext = null;
    let ws = null;
    let sessionId = null;
    let timerInterval = null;
    let recordingStartTime = null;
    let finalTranscript = '';
    let finalTranslation = '';
    let currentLanguage = 'en';
    let autoSaveInterval = null;
    let currentR2Key = null;

    // ============ AUTO-SAVE & RECOVERY ============
    const STORAGE_KEY = 'dd_recording_backup';

    function saveToLocalStorage() {
      if (!finalTranscript && !finalTranslation) return;
      const backup = {
        transcript: finalTranscript,
        translation: finalTranslation,
        language: currentLanguage,
        timestamp: Date.now(),
        duration: recordingStartTime ? Math.floor((Date.now() - recordingStartTime) / 1000) : 0
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(backup));
      console.log('[AutoSave] Backup saved');
    }

    function checkForRecovery() {
      const backup = localStorage.getItem(STORAGE_KEY);
      if (backup) {
        try {
          const data = JSON.parse(backup);
          // Only show recovery if backup is less than 24 hours old
          if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000 && data.transcript) {
            document.getElementById('recoveryBanner').style.display = 'flex';
            return data;
          }
        } catch (e) { console.error('Recovery parse error:', e); }
      }
      return null;
    }

    window.restoreSession = function() {
      const backup = localStorage.getItem(STORAGE_KEY);
      if (backup) {
        try {
          const data = JSON.parse(backup);
          finalTranscript = data.transcript || '';
          finalTranslation = data.translation || '';
          currentLanguage = data.language || 'en';

          transcriptContent.innerHTML = finalTranscript;
          transcriptContent.classList.remove('empty');
          detectedLang.textContent = currentLanguage.toUpperCase();

          if (finalTranslation) {
            translationContent.textContent = finalTranslation;
            translationPanel.style.display = 'flex';
          }

          recordSubmitBtn.disabled = false;
          recordStatus.textContent = `Restored ${Math.floor(data.duration / 60)}m ${data.duration % 60}s of transcript`;

          // Switch to record tab
          tabs.forEach(t => t.classList.remove('active'));
          modes.forEach(m => m.classList.remove('active'));
          document.querySelector('[data-mode="record"]').classList.add('active');
          document.getElementById('recordMode').classList.add('active');
        } catch (e) { console.error('Restore error:', e); }
      }
      document.getElementById('recoveryBanner').style.display = 'none';
    };

    window.dismissRecovery = function() {
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('recoveryBanner').style.display = 'none';
    };

    // Check for recovery on page load
    checkForRecovery();

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        tabs.forEach(t => t.classList.remove('active'));
        modes.forEach(m => m.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(mode + 'Mode').classList.add('active');
      });
    });

    // Language selection
    langBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        langBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLang = btn.dataset.lang;
      });
    });

    // ============ UPLOAD MODE ============

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('active'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('active'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('active'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
      const allowed = ['pdf', 'ppt', 'pptx', 'doc', 'docx', 'txt', 'rtf', 'csv', 'xlsx', 'xls', 'mp3', 'wav', 'm4a', 'webm', 'ogg'];
      const newFiles = Array.from(files).filter(f => {
        const ext = f.name.split('.').pop().toLowerCase();
        return allowed.includes(ext) && f.size <= 50 * 1024 * 1024;
      });
      selectedFiles = [...selectedFiles, ...newFiles].slice(0, 10);
      updateFileList();
    }

    function updateFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
      }
      fileList.innerHTML = selectedFiles.map((f, i) => `
        <div class="dd-file-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          <span>${f.name}</span>
          <button onclick="removeFile(${i})">&times;</button>
        </div>
      `).join('');
    }

    window.removeFile = function(i) { selectedFiles.splice(i, 1); updateFileList(); };

    async function extractPDFText(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(' ') + '\n\n';
        }
        return text;
      } catch (e) { return `[Could not extract: ${file.name}]`; }
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function processFiles(files) {
      const results = { documents: [], audioFiles: [] };
      for (const file of files) {
        const ext = file.name.split('.').pop().toLowerCase();
        const audioExts = ['mp3', 'wav', 'm4a', 'webm', 'ogg', 'aac', 'flac'];

        if (audioExts.includes(ext)) {
          const base64 = await fileToBase64(file);
          results.audioFiles.push({ name: file.name, type: ext, content: base64, mimeType: file.type || `audio/${ext}`, isAudio: true });
        } else {
          let content = '';
          if (ext === 'pdf') {
            content = await extractPDFText(file);
          } else if (['txt', 'rtf', 'csv'].includes(ext)) {
            content = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsText(file); });
          } else {
            const base64 = await fileToBase64(file);
            content = `[BASE64:${ext}]${base64}`;
          }
          results.documents.push({ name: file.name, type: ext, content, isAudio: false });
        }
      }
      return results;
    }

    uploadSubmitBtn.addEventListener('click', async () => {
      const email = document.getElementById('uploadEmail').value.trim();
      const instructions = document.getElementById('uploadInstructions').value.trim();
      const reportLength = document.getElementById('uploadLength').value;

      if (selectedFiles.length === 0) { alert('Please upload at least one file'); return; }
      if (!email) { alert('Please enter your email'); return; }

      uploadSubmitBtn.disabled = true;
      uploadSubmitBtn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25" fill="none"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" opacity="0.75"></path></svg> Processing...';
      hideMessages();

      try {
        const processed = await processFiles(selectedFiles);

        const response = await fetch(`${API_BASE}/api/due-diligence`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: processed.documents,
            audioFiles: processed.audioFiles,
            instructions,
            reportLength,
            email,
            generateWord: true
          })
        });

        if (!response.ok) throw new Error('Request failed');

        showSuccess(`DD Report & Transcript will be emailed to ${email} within 10-15 minutes.`);
        selectedFiles = [];
        updateFileList();
        document.getElementById('uploadInstructions').value = '';
      } catch (err) {
        showError(err.message);
      } finally {
        uploadSubmitBtn.disabled = false;
        uploadSubmitBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg> Generate DD Report & Transcript';
      }
    });

    // ============ RECORD MODE ============

    recordBtn.addEventListener('click', async () => {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    });

    async function startRecording() {
      try {
        // Get microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // Set up audio context for resampling to 16kHz
        audioContext = new AudioContext({ sampleRate: 16000 });
        const source = audioContext.createMediaStreamSource(stream);
        const processor = audioContext.createScriptProcessor(4096, 1, 1);

        // Connect WebSocket
        ws = new WebSocket(`${WS_BASE}/ws/transcribe`);

        ws.onopen = () => {
          console.log('WebSocket connected');
          ws.send(JSON.stringify({ type: 'start', language: selectedLang }));
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === 'session') {
            sessionId = data.sessionId;
          } else if (data.type === 'ready') {
            // Start sending audio
            source.connect(processor);
            processor.connect(audioContext.destination);
          } else if (data.type === 'transcript') {
            currentLanguage = data.language;
            detectedLang.textContent = data.language?.toUpperCase() || '--';

            if (data.isFinal) {
              finalTranscript += data.text + ' ';
              transcriptContent.innerHTML = finalTranscript;
            } else {
              transcriptContent.innerHTML = finalTranscript + '<span class="interim">' + data.text + '</span>';
            }
            transcriptContent.classList.remove('empty');
            transcriptContent.scrollTop = transcriptContent.scrollHeight;

            // Show translation panel if non-English
            if (data.language && data.language !== 'en') {
              translationPanel.style.display = 'flex';
            }
          } else if (data.type === 'translation') {
            finalTranslation = data.fullTranslation;
            translationContent.textContent = finalTranslation;
            translationContent.scrollTop = translationContent.scrollHeight;
          } else if (data.type === 'complete') {
            // Recording complete - store R2 key for download
            if (data.r2Key) {
              currentR2Key = data.r2Key;
              downloadRecordingBtn.style.display = 'inline-block';
            }
          } else if (data.type === 'error') {
            showError(data.message);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          showError('Connection error. Please try again.');
          stopRecording();
        };

        // Process audio and send to WebSocket
        processor.onaudioprocess = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const inputData = e.inputBuffer.getChannelData(0);
            // Convert float32 to int16
            const int16Data = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              int16Data[i] = Math.max(-32768, Math.min(32767, Math.floor(inputData[i] * 32768)));
            }
            ws.send(int16Data.buffer);
          }
        };

        // Store for cleanup
        mediaRecorder = { stream, processor, source };

        // Update UI
        isRecording = true;
        recordBtn.classList.add('recording');
        recordIcon.innerHTML = '<rect x="6" y="6" width="12" height="12" rx="2"/>';
        recordTimer.classList.add('recording');
        recordStatus.classList.add('recording');
        recordStatus.textContent = 'Recording... Click to stop';
        recordSubmitBtn.disabled = true;

        // Start timer
        recordingStartTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);

        // Start auto-save every 10 seconds
        autoSaveInterval = setInterval(saveToLocalStorage, 10000);

        // Clear previous transcript and backup
        finalTranscript = '';
        finalTranslation = '';
        currentR2Key = null;
        localStorage.removeItem(STORAGE_KEY);
        transcriptContent.innerHTML = '';
        transcriptContent.classList.add('empty');
        transcriptContent.textContent = 'Listening...';
        translationContent.textContent = '';
        translationPanel.style.display = 'none';
        detectedLang.textContent = '--';
        downloadRecordingBtn.style.display = 'none';
        document.getElementById('recoveryBanner').style.display = 'none';

      } catch (err) {
        console.error('Recording error:', err);
        showError('Could not access microphone. Please allow microphone access.');
      }
    }

    function stopRecording() {
      isRecording = false;

      // Stop timer and auto-save
      clearInterval(timerInterval);
      clearInterval(autoSaveInterval);

      // Final save to localStorage (in case user doesn't submit immediately)
      saveToLocalStorage();

      // Update UI
      recordBtn.classList.remove('recording');
      recordIcon.innerHTML = '<circle cx="12" cy="12" r="8"/>';
      recordTimer.classList.remove('recording');
      recordStatus.classList.remove('recording');
      recordStatus.textContent = 'Recording complete. Click to record again.';

      // Cleanup audio
      if (mediaRecorder) {
        mediaRecorder.processor.disconnect();
        mediaRecorder.source.disconnect();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        mediaRecorder = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      // Tell server to stop
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'stop' }));
      }

      // Enable submit if we have transcript
      if (finalTranscript.trim()) {
        recordSubmitBtn.disabled = false;
      }
    }

    function updateTimer() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      recordTimer.textContent = `${mins}:${secs}`;
    }

    // Download recording from R2
    downloadRecordingBtn.addEventListener('click', () => {
      if (!currentR2Key) {
        showError('No recording available');
        return;
      }

      // Open download in new tab
      const downloadUrl = `${API_BASE}/api/recording/${encodeURIComponent(currentR2Key)}`;
      window.open(downloadUrl, '_blank');
    });

    recordSubmitBtn.addEventListener('click', async () => {
      const email = document.getElementById('recordEmail').value.trim();
      const instructions = document.getElementById('recordInstructions').value.trim();

      if (!finalTranscript.trim()) { alert('No transcript available'); return; }
      if (!email) { alert('Please enter your email'); return; }

      recordSubmitBtn.disabled = true;
      recordSubmitBtn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25" fill="none"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" opacity="0.75"></path></svg> Sending...';
      hideMessages();

      try {
        // Send transcript directly for report generation
        const response = await fetch(`${API_BASE}/api/due-diligence`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: [{
              name: `Recording_${new Date().toISOString().slice(0,10)}`,
              type: 'transcript',
              content: finalTranslation || finalTranscript,
              isAudio: false
            }],
            audioFiles: [],
            instructions,
            reportLength: 'medium',
            email,
            generateWord: true,
            rawTranscript: finalTranscript,
            translatedTranscript: finalTranslation,
            detectedLanguage: currentLanguage,
            sessionId
          })
        });

        if (!response.ok) throw new Error('Request failed');

        showSuccess(`DD Report & Transcript will be emailed to ${email} within 10-15 minutes.`);

        // Clear backup since successfully submitted
        localStorage.removeItem(STORAGE_KEY);

        // Reset
        finalTranscript = '';
        finalTranslation = '';
        currentR2Key = null;
        transcriptContent.innerHTML = '';
        transcriptContent.classList.add('empty');
        transcriptContent.textContent = 'Start recording to see live transcription...';
        translationContent.textContent = '';
        translationPanel.style.display = 'none';
        downloadRecordingBtn.style.display = 'none';
        recordTimer.textContent = '00:00';
        document.getElementById('recordInstructions').value = '';
      } catch (err) {
        showError(err.message);
      } finally {
        recordSubmitBtn.disabled = false;
        recordSubmitBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Send DD Report & Transcript';
      }
    });

    // ============ HELPERS ============

    function showSuccess(msg) {
      successText.textContent = msg;
      successMessage.classList.add('show');
      errorMessage.classList.remove('show');
    }

    function showError(msg) {
      errorText.textContent = msg;
      errorMessage.classList.add('show');
      successMessage.classList.remove('show');
    }

    function hideMessages() {
      successMessage.classList.remove('show');
      errorMessage.classList.remove('show');
    }
  </script>
</body>
</html>
