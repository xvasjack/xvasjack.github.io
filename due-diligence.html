<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Due Diligence Report Generator</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    .page-content.dd-container {
      display: block !important;
      align-items: unset !important;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .dd-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .dd-header h1 {
      font-size: 22px;
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    .dd-header p {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
    }

    /* Upload Zone */
    .dd-upload-zone {
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-md);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-body);
      margin-bottom: 16px;
    }
    .dd-upload-zone:hover, .dd-upload-zone.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .dd-upload-zone svg {
      color: var(--accent);
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
    }
    .dd-upload-zone p {
      font-size: 16px;
      color: var(--text-main);
      margin: 0 0 8px 0;
    }
    .dd-upload-zone span {
      font-size: 13px;
      color: var(--text-muted);
    }
    #fileInput { display: none; }

    .dd-file-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    .dd-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
    }
    .dd-file-item svg { width: 20px; height: 20px; color: #3b82f6; flex-shrink: 0; }
    .dd-file-item span {
      flex: 1;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #1e293b;
    }
    .dd-file-item .file-size {
      font-size: 12px;
      color: #64748b;
      flex-shrink: 0;
    }
    .dd-file-item button {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #dc2626;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }
    .dd-file-item button:hover { background: #fecaca; }

    /* Form Section */
    .dd-form-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
    }
    .dd-form-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .dd-form-label label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }
    .dd-mode-toggle {
      display: flex;
      gap: 6px;
    }
    .dd-mode-btn {
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--border-medium);
      border-radius: 4px;
      background: var(--bg-body);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .dd-mode-btn:hover { border-color: var(--accent); color: var(--accent); }
    .dd-mode-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .dd-auto-hint {
      font-size: 13px;
      color: var(--text-muted);
      padding: 12px;
      background: var(--accent-soft);
      border-radius: 4px;
      margin-bottom: 12px;
    }
    .dd-instructions-box {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-medium);
      border-radius: 4px;
      font-size: 13px;
      resize: vertical;
      min-height: 100px;
      line-height: 1.5;
      font-family: inherit;
    }
    .dd-instructions-box:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Submit Button */
    .dd-submit-btn {
      width: 100%;
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background 0.2s;
    }
    .dd-submit-btn:hover { background: var(--accent-hover); }
    .dd-submit-btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }
    .dd-submit-btn svg { width: 20px; height: 20px; }

    /* Supported formats */
    .dd-formats {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 8px;
    }

    /* Spinner */
    .spinner {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <a href="find-target.html" class="logo">
      <span class="logo-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
      </span>
      YCP Gary Team's Tool
    </a>
    <nav>
      <div class="nav-dropdown">
        <button class="nav-dropdown-toggle">
          Search
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="nav-dropdown-menu">
          <a href="find-target.html">v3 Search</a>
          <a href="find-target-v5.html">v5 Search</a>
          <a href="find-target-v6.html">v6 Search</a>
        </div>
      </div>
      <a href="validation.html">Validation</a>
      <a href="trading-comparable.html">Trading Comp</a>
      <a href="profile-slides.html">Slides</a>
      <a href="utb.html">UTB</a>
      <a href="market-research.html">Market Research</a>
      <a href="due-diligence.html" class="active">Due Diligence</a>
      <div class="nav-dropdown">
        <button class="nav-dropdown-toggle">
          Other Tools
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="nav-dropdown-menu">
          <a href="find-target-slow.html">v3 Slow</a>
          <a href="find-target-v4.html">v4 Search</a>
        </div>
      </div>
    </nav>
    <div class="header-email">
      <span class="header-email-label">Your email:</span>
      <input type="email" id="globalEmail" placeholder="your@company.com">
    </div>
  </header>

  <main class="app-main" style="padding-top: 20px;">
    <section class="page-content dd-container">
      <!-- Header -->
      <div class="dd-header">
        <h1>Due Diligence Report Generator</h1>
        <p>Upload documents and receive a comprehensive DD report in Word format</p>
      </div>

      <!-- Messages -->
      <div class="message success" id="successMessage">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <span id="successText">Success!</span>
      </div>
      <div class="message error" id="errorMessage">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        <span id="errorText">Error</span>
      </div>

      <!-- Upload Zone -->
      <input type="file" id="fileInput" multiple accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.rtf,.csv,.xlsx,.xls">
      <div class="dd-upload-zone" id="uploadZone">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p>Drop files here or click to upload</p>
        <span>PDF, Word, PowerPoint, Excel, TXT (max 50MB each)</span>
      </div>
      <div class="dd-formats">Supported: .pdf .doc .docx .ppt .pptx .xls .xlsx .txt .csv .rtf</div>

      <!-- File List -->
      <div class="dd-file-list" id="fileList"></div>

      <!-- Instructions Section -->
      <div class="dd-form-section">
        <div class="dd-form-label">
          <label>Instructions</label>
          <div class="dd-mode-toggle">
            <button type="button" class="dd-mode-btn active" id="autoModeBtn" onclick="setInstructionMode('auto')">Auto</button>
            <button type="button" class="dd-mode-btn" id="manualModeBtn" onclick="setInstructionMode('manual')">Manual</button>
          </div>
        </div>
        <div class="dd-auto-hint" id="autoModeHint">
          AI will automatically analyze uploaded documents and generate a comprehensive DD report.
        </div>
        <textarea id="ddInstructions" class="dd-instructions-box" rows="5" placeholder="Example instructions:
• Focus on financial performance and risks
• Summarize key findings for buyer's perspective
• Highlight any red flags or concerns
• Include market position analysis" style="display: none;"></textarea>
      </div>

      <!-- Submit Button -->
      <button type="button" class="dd-submit-btn" id="ddSubmitBtn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Generate DD Report
      </button>
    </section>
  </main>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Email caching
    const globalEmailInput = document.getElementById('globalEmail');
    const cachedEmail = localStorage.getItem('ycpUserEmail');
    if (cachedEmail) {
      globalEmailInput.value = cachedEmail;
    }
    globalEmailInput.addEventListener('input', () => {
      localStorage.setItem('ycpUserEmail', globalEmailInput.value);
    });

    const API_BASE = 'https://xvasjackgithubio-production.up.railway.app';

    // Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const ddSubmitBtn = document.getElementById('ddSubmitBtn');
    const ddInstructions = document.getElementById('ddInstructions');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const successText = document.getElementById('successText');
    const errorText = document.getElementById('errorText');

    let selectedFiles = [];
    let instructionMode = 'auto';

    // Instruction mode toggle
    window.setInstructionMode = function(mode) {
      instructionMode = mode;
      const autoBtn = document.getElementById('autoModeBtn');
      const manualBtn = document.getElementById('manualModeBtn');
      const autoHint = document.getElementById('autoModeHint');
      const instructionsBox = document.getElementById('ddInstructions');

      if (mode === 'auto') {
        autoBtn.classList.add('active');
        manualBtn.classList.remove('active');
        autoHint.style.display = 'block';
        instructionsBox.style.display = 'none';
      } else {
        autoBtn.classList.remove('active');
        manualBtn.classList.add('active');
        autoHint.style.display = 'none';
        instructionsBox.style.display = 'block';
      }
    };

    // Upload handlers
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('active'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('active'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('active'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
      const allowed = ['pdf', 'ppt', 'pptx', 'doc', 'docx', 'txt', 'rtf', 'csv', 'xlsx', 'xls'];
      const newFiles = Array.from(files).filter(f => {
        const ext = f.name.split('.').pop().toLowerCase();
        return allowed.includes(ext) && f.size <= 50 * 1024 * 1024;
      });
      selectedFiles = [...selectedFiles, ...newFiles].slice(0, 10);
      updateFileList();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function updateFileList() {
      fileList.innerHTML = '';
      if (selectedFiles.length === 0) return;

      selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'dd-file-item';
        item.innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span>${file.name}</span>
          <span class="file-size">${formatFileSize(file.size)}</span>
          <button onclick="removeFile(${index})">Remove</button>
        `;
        fileList.appendChild(item);
      });
    }

    window.removeFile = function(i) {
      selectedFiles.splice(i, 1);
      updateFileList();
    };

    async function extractPDFText(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(' ') + '\n\n';
        }
        return text;
      } catch (e) {
        return `[Could not extract: ${file.name}]`;
      }
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function processFiles(files) {
      const results = { documents: [] };

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const ext = file.name.split('.').pop().toLowerCase();

        try {
          let content = '';
          if (ext === 'pdf') {
            content = await extractPDFText(file);
          } else if (['txt', 'rtf', 'csv'].includes(ext)) {
            content = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(e.target.result);
              reader.onerror = () => reject(new Error('Failed to read text file'));
              reader.readAsText(file);
            });
          } else {
            const base64 = await fileToBase64(file);
            content = `[BASE64:${ext}]${base64}`;
          }
          results.documents.push({ name: file.name, type: ext, content, isAudio: false });
        } catch (fileError) {
          results.documents.push({
            name: file.name,
            type: ext,
            content: `[Error processing file ${file.name}: ${fileError.message}]`,
            isAudio: false
          });
        }
      }
      return results;
    }

    // Submit handler
    ddSubmitBtn.addEventListener('click', async () => {
      const email = globalEmailInput.value.trim() || localStorage.getItem('ycpUserEmail');
      const instructions = ddInstructions.value.trim();

      if (selectedFiles.length === 0) {
        showError('Please upload at least one file');
        return;
      }
      if (!email) {
        showError('Please enter your email in the top right');
        return;
      }

      ddSubmitBtn.disabled = true;
      ddSubmitBtn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25" fill="none"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" opacity="0.75"></path></svg> Processing...';
      hideMessages();

      try {
        const processed = await processFiles(selectedFiles);

        const response = await fetch(`${API_BASE}/api/due-diligence`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: processed.documents,
            audioFiles: [],
            instructions: instructionMode === 'manual' ? instructions : '',
            instructionMode,
            reportLength: 'medium',
            email,
            generateWord: true
          })
        });

        if (!response.ok) throw new Error('Request failed');

        showSuccess(`DD Report will be emailed to ${email} within 10-15 minutes.`);

        // Clear files for next submission
        selectedFiles = [];
        updateFileList();
        ddInstructions.value = '';

      } catch (err) {
        showError(err.message);
      } finally {
        ddSubmitBtn.disabled = false;
        ddSubmitBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg> Generate DD Report`;
      }
    });

    function showSuccess(msg) {
      successText.textContent = msg;
      successMessage.classList.add('show');
      errorMessage.classList.remove('show');
      setTimeout(() => successMessage.classList.remove('show'), 8000);
    }

    function showError(msg) {
      errorText.textContent = msg;
      errorMessage.classList.add('show');
      successMessage.classList.remove('show');
      setTimeout(() => errorMessage.classList.remove('show'), 5000);
    }

    function hideMessages() {
      successMessage.classList.remove('show');
      errorMessage.classList.remove('show');
    }
  </script>
</body>
</html>
