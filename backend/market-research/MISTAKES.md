# Mistakes Log (Market Research)

Purpose: record concrete mistakes, why they hurt, and how to prevent repeats.

## Hard Rules (Do Not Break)

1. Gemini `gemini-3-flash` rate-limit protection is mandatory: keep retries simple (`base >= 10s`) and reduce parallel fan-out for heavy synthesis calls; avoid retry storms.
2. `ULTRA HIGH PRIORITY`: Before any paid implementation/run, perform a triple-check root-cause proof (3 independent checks: logs + code-path trace + artifact/XML/visual evidence). If root cause is not proven, do **not** spend model tokens on fixes.
3. Fix one issue at a time: one root cause -> one code change -> validation -> report. Queue follow-up issues for the next iteration.
4. Explain status in high-school-level plain English. If technical terms are unavoidable, define them in one short sentence.

## 2026-02-11

| # | Mistake | Why it was wrong | Prevention rule |
|---|---------|------------------|-----------------|
| 1 | Ran diagnostics/grep from the wrong path (`/home/xvasjack` instead of repo root). | Lost time and produced false "missing file/repo" errors. | Always run `pwd` + `git rev-parse --show-toplevel` before investigation/edits. |
| 2 | Triggered expensive backend runs before fully hardening known failure paths. | Burned budget on repeated failures that were already visible in logs. | No paid run until static checks + code-path checks pass (see checklist below). |
| 3 | Allowed synthesis prompts to instruct placeholder strings like `"Insufficient research data for this field"`. | Final review flags these as credibility failures; coherence drops below gate. | Use `null`/empty structures, never placeholder prose in client-facing fields. |
| 4 | Accepted `_wasArray` fallback results after retries for key sections. | Schema quality degraded and section integrity became unstable across passes. | For required sections, fail fast or force object re-synthesis; do not silently accept array-converted output. |
| 5 | Relied on repeated deepen/review loops despite persistent `coverage=75` plateau. | High cost with low marginal quality improvement. | Add stagnation detector: if score plateaus across loops, switch strategy (targeted fixes) instead of repeating same loop. |
| 6 | Let summary/insight completeness regress during re-synthesis passes. | Quality gate failed with `only 1 key insights (need ≥3)`. | Re-apply summary completeness guard after every section re-synthesis, not just initial synthesis. |
| 7 | Treated formatting overflow too rigidly in some checks. | Can reduce content quality even when user priority is insight depth. | Content first: allow controlled overflow/flex layout, then trim wording selectively. |
| 8 | Did not enforce a strict "pre-run QA contract" before long runs. | Repeated runtime discovery of issues that should be caught locally. | Use mandatory pre-run QA checklist and block run if any item fails. |
| 9 | Let `review-deepen` loops continue when coverage repeatedly plateaued at 75/100. | Burned cost with near-zero quality gain. | Detect stagnation and stop repeated deepen cycles when score delta is negligible across passes. |
| 10 | Allowed policy/market retries to continue even when array payload was already salvageable. | Extra paid model calls were spent on retries that were not improving structure. | Normalize and validate array-tagged payloads early; accept salvage when core sections are present. |
| 11 | Kept strict overflow-related hard failures in depth/competitor validation. | Penalized content quality despite user priority on insight depth. | Treat overflow as warning-level for validation; only hard-fail for thin/empty content or broken output. |
| 12 | Re-synthesis prompt still asked to flag uncertainty with terms like "estimated/unverified". | Encouraged wording that later quality checks treat as weak/placeholder content. | Force `null`/empty values for uncertain data and ban hedging placeholders in re-synthesis prompts. |
| 13 | Final-review fixer listed `depth` in re-synthesis targets but did not implement a `depth` fix path. | Major depth issues remained unresolved across passes, keeping coherence below gate and wasting loops. | Keep fixer capabilities in lockstep with allowed `sectionFixes`; add explicit `depth` handling with summary/depth regeneration. |
| 14 | Allowed off-scope gap/deepen queries (e.g., adjacent sectors) to enter the pipeline. | Created narrative drift, inconsistent policy/market storyline, and lower coherence despite high raw score. | Sanitize all generated queries by country/industry scope before running research. |
| 15 | Final-review stagnation signature keyed on verbose issue text. | Small wording changes bypassed stagnation detection, causing repeated expensive cycles on same issue set. | Use normalized issue signatures (severity+section+type+query signature), not free-text descriptions. |
| 16 | Universal agent merged failed first-pass content with retry-success content. | Contradictory claims from failed output leaked into synthesis, damaging coherence and trust. | On successful retry, replace content/citations with retry payload; never concatenate failed + fixed outputs. |
| 17 | Market synthesis lacked robust unwrapping of nested `section_0`/numeric containers. | Valid data looked "thin" to validators, triggering unnecessary retries and extra model spend. | Normalize nested/array-shaped market payloads before validation and quantify from normalized sections. |
| 18 | Final review escalated credibility/placeholder issues to new research queries. | Wasted budget hunting data instead of removing unsupported claims from synthesis. | Force suspicious/hallucination cleanup to `synthesis` escalation and sanitize/drop speculative gap queries. |
| 19 | Treated reviewer scores as raw values without numeric normalization. | String-like scores (e.g., `"75/100"`) bypassed stagnation guards, causing redundant 5-pass loops. | Normalize all scores with robust parsing before comparisons and gate checks. |
| 20 | Allowed legal/research gaps that were not grounded in synthesized evidence. | Triggered speculative searches (hallucinated decrees/resolutions), adding cost and coherence noise. | Drop legal-token gaps unless the same token already appears in synthesized content. |
| 21 | Ignored array payload variants in policy normalization (arrays inside `section_n`). | Policy retries repeated despite salvageable payload structure. | Normalize both object and array section payloads; map arrays to acts/targets/incentives where structurally valid. |
| 22 | Did not enforce default slide-title hygiene in section validators. | Final review flagged "sloppy slide titles," lowering coherence despite adequate data. | Apply deterministic fallback titles for policy/market/competitor sections during validation. |
| 23 | `validateContentDepth` computed `overall` from policy/market/competitors only, while summary/depth failures still blocked readiness later. | Produced misleading high effective scores that hid coherence risk and wasted review/deepen cycles. | Include summary and depth in `overall` scoring so upstream gate reflects true client-readiness quality. |
| 24 | Policy synthesis acceptance checked only object-shell presence after validation (`foundationalActs`/`nationalPolicy`/`investmentRestrictions`). | Validation auto-created empty objects, so weak payloads were accepted as "structured," degrading narrative quality. | Gate policy acceptance on evidence-bearing fields (named acts/targets/incentives), not object existence. |
| 25 | Deep-dive prompt mixed writing personas and included Thailand-specific examples in Vietnam runs. | Caused narrative drift and inconsistent tone, lowering final coherence despite strong raw data coverage. | Keep a single persona (McKinsey strategy partner) and remove off-country examples from all prompts. |
| 26 | Quality-gate error text claimed only `>=80` threshold while real gate also required zero critical/major/open gaps. | Misled operators: logs showed `effective=80+` but run still failed with no clear reason. | Always include full gate criteria and per-country readiness reasons in thrown errors/diagnostics. |
| 27 | Final-review readiness required `major=0` and `openGaps=0`, making the gate too brittle for noisy reviewer outputs. | Good analyses (80+ coherent, no critical issues) were repeatedly blocked and re-run, burning cost/time. | Keep strict `critical=0` + coherence threshold, but allow bounded major/open-gap residuals with explicit limits. |
| 28 | Background timeout was 25 minutes while API advertised 30-60 minutes. | Runs near completion were aborted inconsistently, causing needless failures and retrigger cycles. | Align timeout with expected runtime (>=45 minutes) or make it configurable by mode. |
| 29 | `validateMarketSynthesis` accepted arbitrary non-underscore object keys as market sections. | Transient keys (`marketDeepen*`, `section_*`) leaked into deck generation, causing layout drift and truncation across market slides. | Canonicalize market output to stable keys only (`marketSizeAndGrowth`, `supplyAndDemandDynamics`, `pricingAndTariffStructures`) and drop transient extras. |
| 30 | Policy/market synthesis acceptance evaluated success before rejecting `_wasArray` origin payloads. | Array-origin structures were silently accepted as “good enough,” increasing schema instability and downstream formatting chaos. | In policy/market synthesis loops, reject `_wasArray` payloads first; only accept object-origin payloads with evidence-bearing structure. |
| 31 | No hard post-generation PPT structural gate before email/download. | Corrupted or heavily truncated decks could still be delivered, leading to PowerPoint repair prompts and unusable outputs. | Run a mandatory structural validator on final PPT (ZIP/XML integrity + minimum structure checks) and block delivery on failure. |
| 32 | Transient synthesis-key filters were case/shape brittle (`market_deepen_*` only). | CamelCase keys like `marketDeepenFinalReviewGap1` and numeric wrappers bypassed filters and rendered as bogus slides. | Normalize keys to lowercase before transient matching and support camel/snake variants for deepen/final-review keys. |
| 33 | Section-content checks relied on shallow string checks (`"Data unavailable"` only). | Truncated payloads and semantic placeholders passed as “content,” then surfaced as broken/truncated slides. | Use semantic content validation (placeholder + truncation detection + minimum meaningful narrative signal) before slide generation. |
| 34 | PPT quality gate treated “non-unavailable” as “valid data.” | JSON-fragment or thin placeholders looked passable to gate logic, so low-quality blocks survived until late review. | Gate on semantic renderability (`blockHasRenderableData`) instead of type/content flags alone. |
| 35 | Repaired JSON payloads were accepted without semantic viability checks. | Tier-2/3 repaired objects sometimes preserved malformed/thin sections, causing layout drift and credibility issues. | After JSON repair, run semantic viability checks per section and force re-synthesis for weak/truncated sections. |
| 36 | Section preview/count path used sanitized payloads, but actual render path still classified raw section payloads. | Transient keys (e.g., `marketDeepen*`, `section_*`) leaked into live slide generation even when previews looked clean. | Use one render-normalized payload path for both preview/count and actual generation. |
| 37 | Final deck generation lacked a hard internal relationship-target integrity gate. | Decks could pass formatting audit yet still open with PowerPoint “repair” prompts due broken `.rels` targets. | Enforce post-generation relationship integrity (`scanRelationshipTargets`) and block output on any missing internal target. |
| 38 | Render layer assumed canonical section objects and did not recover array-shaped section payloads deterministically. | `_wasArray`/`section_0` style outputs produced unstable mapping, missing tables, and inconsistent slide formatting. | Apply deterministic alias-based render normalization (canonical keys + controlled alias fallback) before any section classification. |
| 39 | Final write path normalized relationship targets but never reconciled `[Content_Types].xml` to actual package parts. | PowerPoint could still prompt “repair” due dangling/missing overrides even when charts/relations looked valid. | Reconcile content-type overrides against real ZIP parts before delivery (`reconcileContentTypesAndPackage`). |
| 40 | Multi-country generation lacked the same structural hard-gates used in single-country generation. | Inconsistent behavior allowed structurally weak decks to slip through one path while blocked in another. | Apply identical post-write integrity gates (relationship + package consistency) across all generator paths. |
| 41 | Kept stale market quality schema (`tpes/finalDemand/escoMarket`) after market synthesis moved to canonical sections. | Gates scored the wrong structure, so low-depth market output could appear acceptable and retries were misdirected. | Validate only canonical market sections (`marketSizeAndGrowth`, `supplyAndDemandDynamics`, `pricingAndTariffStructures`). |
| 42 | Allowed truncation-repaired/array-normalized synthesis payloads by default in fallback tiers. | Repaired but semantically weak payloads leaked into slides, causing truncation artifacts and unstable formatting in final decks. | Default fallback to strict mode: no truncation repair, no array normalization unless explicitly enabled per call site. |
| 43 | Left template-fidelity metrics as warning-only (`tableRecovery`, `nonTemplatePatterns`, `geometryIssues`). | Decks could pass with visible pixel/layout drift and table recovery hacks, producing “all over the place” formatting. | Promote template-fidelity metrics to hard quality gates; keep overflow as warning-only. |
| 44 | Kept `synthesizeMarket` retries 2/3 on manual `callGeminiPro` + parse/extract path instead of shared strict fallback. | Those retries bypassed the unified semantic acceptance flow, so malformed/transient payloads could survive deeper into generation. | Route all retries through `synthesizeWithFallback` with identical strict accept criteria and transient-key rejection. |
| 45 | Policy acceptance normalized payloads before explicitly rejecting transient top-level keys. | `section_*`/deepen wrappers could be transformed into “valid-looking” policy objects, masking root payload corruption. | Reject transient top-level keys first, then normalize/validate only clean object-origin payloads. |
| 46 | Kept legacy renderer assumptions around `section_*` dynamic labels/comments. | Allowed future regressions where transient wrapper keys look intentionally supported in rendering logic. | Remove `section_*` label handling from render paths; keep only canonical/alias-driven keys. |
| 47 | Allowed “Draft PPT mode” to bypass readiness blocks while major/open quality issues remained. | Produced downloadable decks that still needed PowerPoint repair and had severe formatting/content defects. | Restrict draft bypass to explicit debug mode only, never default production runs; enforce final structural + fidelity gates before delivery. |
| 48 | `synthesizeSummary` accepted `summary/depth` payloads without canonical top-level key enforcement. | Transient/unknown keys were treated as valid, feeding unstable structures into final review and PPT mapping. | In summary acceptance, reject transient keys and non-canonical top-level keys for both `summary` and `depth`. |
| 49 | `reSynthesize` acceptance validated only core sections (`policy/market/competitors`) and ignored malformed `summary/depth` payloads. | Re-synthesis could pass while still carrying broken `summary/depth` structures, causing repeated late-stage fixes and extra spend. | Validate `summary/depth` schemas (when present) in re-synthesis acceptance using the same strict canonical key rules. |
| 50 | PPT hyperlink fields used raw URLs from model output in multiple render paths. | Invalid or non-http URL payloads can corrupt PPT XML relationships and trigger PowerPoint repair dialogs. | Sanitize all hyperlink URLs (`http/https` only) before any `hyperlink.url` write in utilities and slide renderers. |
| 51 | `safeCell` clipping remained aggressive and appended ellipses to normal narrative text. | Visible truncation reduced readability and made decks look unfinished even when source content was good. | Preserve content by default; only hard-trim pathological payload sizes, not normal cell content. |
| 52 | Multi-country competitor slide path still wrote `hyperlink.url` from raw `p.website` without URL sanitation. | One malformed website value can create invalid relationship targets and force PowerPoint repair on open. | Run `sanitizeHyperlinkUrl` at final write sites in multi-country renderer before emitting any hyperlink relationship. |
| 53 | Package reconciliation was run once, but there was no mandatory last-mile reconcile/re-scan immediately before returning the final buffer. | Late content-type drift (or stale overrides after internal transforms) could survive and ship a deck that still opens with repair prompts. | Add final `reconcileContentTypesAndPackage` + `scanPackageConsistency` hard-gate at the end of both single and multi-country generators. |
| 54 | Render pipeline lacked an explicit post-normalization guard for unexpected market keys. | If transient keys slip past upstream synthesis, stage-4 render can still drift into extra blocks and visual inconsistency. | Enforce allowed market render key set (`canonical + legacy + sources`) and fail fast in strict mode on any unknown key. |
| 55 | Package consistency gate collected only override/relationship counts and ignored broad content-type mismatches. | Decks could pass “consistency” while still carrying wrong MIME mappings that trigger PowerPoint repair. | Include `missingExpectedOverrides` + `contentTypeMismatches` as hard failures in both single and multi-country generators. |
| 56 | Non-market unknown block keys still fell back to generic rendering. | Unknown/transient blocks silently produced off-template slides and unstable formatting. | Hard-fail unknown non-market keys; only market blocks may use controlled dynamic rendering. |
| 57 | Policy `regulatorySummary` fallback used generic renderer when tabular normalization failed. | One malformed policy object could bypass template table geometry and create visibly inconsistent slides. | Keep policy fallback template-anchored (table rows only) or explicit data-unavailable message; never generic slide fallback. |
| 58 | Market insight fallback scraped arbitrary nested strings from unknown payloads. | Overlong mixed text inflated slide bodies, causing truncation and layout drift despite valid template geometry. | Limit fallback extraction to a short allowlist of high-signal fields and cap fallback insight count. |
| 59 | Market key canonicalization used semantic hints before transient-key rejection. | Transient keys like `marketDeepen*` could be canonized by title text and leak into later rendering paths. | Reject transient keys first in canonicalization, then apply semantic mapping only to clean keys. |
| 60 | `safeText` returned raw strings for `addText` paths instead of XML-safe normalization. | Unpaired surrogates/control chars could leak into slide XML and trigger PowerPoint repair dialogs on open. | Route all text writes through XML-safe `ensureString` (including plain strings), with control-char and surrogate stripping. |
| 61 | Package consistency scanner treated missing `<Override>` as failure even when valid `<Default Extension=...>` existed. | Created false “missing expected overrides” signals and noisy reconciliation loops that masked real package issues. | Parse default content-types and consider extension-level defaults when evaluating expected part coverage. |
| 62 | Package issue logging joined object arrays directly (`.join`) in renderer diagnostics. | Logs emitted `[object Object]`, obscuring the exact broken part/content type and slowing root-cause analysis. | Always format structured issue arrays with explicit field mapping (`part->expectedContentType`). |

## 2026-02-13

| # | Mistake | Why it was wrong | Prevention rule |
|---|---------|------------------|-----------------|
| 63 | Declared root-cause fixes as “done” before validating the exact artifact path the user was opening. | A stale broken file could still be in use, making my status claims look false even when code changed. | Before claiming a fix, verify the exact user-visible output path and run integrity checks on that specific file. |
| 64 | Assumed runtime/deploy state instead of proving what build the live service was serving. | User could run against an older/stale deployment and see no behavior change. | Always verify live runtime state first (diagnostics/status/logs), then tie conclusions to a concrete deployed build. |
| 65 | Focused validation on local `test-output.pptx` without immediately scanning recent user download artifacts. | Missed an obvious explanation for continued repair errors: old broken files in `Downloads/` were still being opened. | Include a “recent artifact sweep” step that checks newest `.pptx` files by mtime and reports broken ones explicitly. |
| 66 | Failed to surface that `/home/xvasjack/Downloads/Market_Research_Vietnam_DRAFT_2026-02-11_latest.pptx` had structural defects (`danglingOverrides=30`, `duplicateNonVisualShapeIds=1`) until late. | This delayed the concrete proof of why user still saw repair errors. | When user reports “still broken,” prioritize file-level package diagnostics before any additional code edits. |
| 67 | Did not immediately provide explicit “open this file, not that one” guidance. | User experience remained confusing despite valid new outputs existing on disk. | Always provide exact replacement path(s) and mark stale/broken file paths when reporting fixes. |
| 68 | Railway CLI token failure was discovered late in debugging. | Slowed down verification of deployed status and increased back-and-forth. | If CLI auth fails, immediately switch to direct health/diagnostic endpoints and continue evidence collection. |
| 69 | Claimed truncation was fixed while active truncation paths still existed in other generators (`ppt-multi-country.js`, `test-vietnam-research.js`, shared `truncate` helpers). | User still received visibly truncated decks, so “fixed” claims were incorrect from user perspective. | Before declaring truncation fixed, run repo-wide truncation-path audit and prove zero suspicious truncation on the exact output path the user will open. |
| 70 | Conflated PPT package repair with content truncation remediation. | Structural repair (`.rels`/content-types/IDs) made files openable but did nothing for clipped narrative text. | Treat integrity and truncation as separate acceptance gates; both must pass before declaring success. |
| 71 | Worked without a single canonical “release output” path contract. | Different files (`backend/.../test-output.pptx` vs `Downloads/...latest.pptx`) showed different quality, creating the appearance of no progress. | Define one canonical output artifact per run and report only that path for acceptance checks. |
| 72 | Stayed too long in incremental patch mode instead of escalating to architecture redesign when repeated attempts failed. | Burned time/tokens while preserving the same root rendering model that causes format drift. | If two consecutive fix rounds fail user acceptance, stop and move to workflow redesign (template-clone mapping only, no ad-hoc layout synthesis). |
| 73 | Did not enforce identical quality gates across all generation entrypoints. | Some paths were hardened while others still emitted truncated/approximate output. | Centralize render and validation contracts so every generator path must pass the same strict template/truncation gates. |
| 74 | Reported improvements before proving the exact file the user reviewed had improved truncation metrics. | Communication and user-visible reality diverged, further eroding trust. | Every success report must include metrics for the exact user-facing file path plus prior-vs-current comparison. |
| 75 | Kept a separate Vietnam test renderer (`test-vietnam-research.js`) with custom slide code after production renderer hardening. | User-visible Vietnam output kept bypassing core fixes, so changes appeared to do nothing. | Route Vietnam test generation through the production `generateSingleCountryPPT` path only; never keep a parallel custom renderer for acceptance outputs. |

## Mandatory Pre-Run QA Checklist (Before Any Paid Run)

1. `pwd` and repo root verified.
2. Lint/type/syntax checks pass for edited files.
3. No prompt text that asks model to output placeholder prose.
4. `_wasArray` handling for policy/market/competitors is strict (no silent degrade path).
5. Summary guard guarantees >=3 structured key insights after any re-synthesis.
6. Quality gate logic inspected for dead loops/stagnation behavior.
7. Formatting pipeline validated locally (slide size, font family, table margins/borders, header/footer geometry).
8. Market synthesis output is canonicalized (no transient/deepen/final-review section keys in final market payload).
9. Final PPT structural validator passes (ZIP parse, XML character integrity, minimum slides/charts/tables).
10. Only then trigger backend run.
