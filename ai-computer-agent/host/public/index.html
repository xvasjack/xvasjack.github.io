<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Computer Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #252540;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .panel {
            background: #252540;
            border-radius: 12px;
            padding: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
        }

        .vm-preview {
            background: #1a1a2e;
            border-radius: 8px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .vm-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .vm-preview-placeholder {
            color: #666;
            font-size: 14px;
        }

        .task-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-input {
            width: 100%;
            padding: 16px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            color: #eee;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .task-input:focus {
            outline: none;
            border-color: #5352ed;
        }

        .task-input::placeholder {
            color: #666;
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .timer-input {
            width: 80px;
            padding: 12px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            color: #eee;
            font-size: 14px;
            text-align: center;
        }

        .timer-input:focus {
            outline: none;
            border-color: #5352ed;
        }

        label {
            font-size: 14px;
            color: #999;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #5352ed;
            color: white;
        }

        .btn-primary:hover {
            background: #3d3cb8;
        }

        .btn-primary:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff2f40;
        }

        .btn-secondary {
            background: #333;
            color: #eee;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-success {
            background: #2ed573;
            color: #1a1a2e;
        }

        .btn-success:hover {
            background: #26c064;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 12px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .message {
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user {
            background: #5352ed;
            margin-left: 40px;
        }

        .message.agent {
            background: #333;
            margin-right: 40px;
        }

        .message.system {
            background: #3d3d5c;
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .task-status {
            padding: 16px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #5352ed;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .plan-section {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .plan-content {
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .plan-actions {
            display: flex;
            gap: 12px;
        }

        .progress-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5352ed, #2ed573);
            transition: width 0.3s;
        }

        .guardrails-info {
            font-size: 12px;
            color: #666;
            padding: 12px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-top: 16px;
        }

        .guardrails-info h4 {
            color: #ff4757;
            margin-bottom: 8px;
        }

        .guardrails-info ul {
            list-style: none;
            padding-left: 0;
        }

        .guardrails-info li {
            padding: 4px 0;
        }

        .guardrails-info li::before {
            content: "âœ— ";
            color: #ff4757;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Computer Agent</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="vmStatus"></div>
                    <span id="vmStatusText">VM Disconnected</span>
                </div>
                <div class="status-indicator">
                    <span id="timerDisplay">00:00:00</span>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <div class="left-column">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">VM Preview</span>
                        <button class="btn btn-secondary" onclick="requestScreenshot()">Refresh</button>
                    </div>
                    <div class="vm-preview" id="vmPreview">
                        <span class="vm-preview-placeholder">No screenshot available</span>
                    </div>

                    <div class="task-status" id="taskStatus" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="panel-title">Current Task</span>
                            <span id="taskStatusBadge" style="padding: 4px 12px; background: #5352ed; border-radius: 12px; font-size: 12px;">Running</span>
                        </div>
                        <p id="taskDescription" style="margin-top: 12px; color: #999; font-size: 14px;"></p>
                        <div class="status-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="iterationCount">0</div>
                                <div class="stat-label">Iterations</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="prsMerged">0</div>
                                <div class="stat-label">PRs Merged</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="elapsedTime">0:00</div>
                                <div class="stat-label">Elapsed</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="plan-section" id="planSection" style="display: none;">
                        <div class="panel-title" style="margin-bottom: 12px;">Proposed Plan</div>
                        <div class="plan-content" id="planContent"></div>
                        <div class="plan-actions">
                            <button class="btn btn-success" onclick="approvePlan()">Approve & Start</button>
                            <button class="btn btn-secondary" onclick="editPlan()">Edit Plan</button>
                            <button class="btn btn-danger" onclick="cancelTask()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Task Input</span>
                    </div>

                    <div class="task-form">
                        <textarea
                            class="task-input"
                            id="taskInput"
                            placeholder="Describe your task...

Example: Run target-v6 search for 'packaging companies in Thailand'. Check the PPT output has at least 20 companies with valid logos and working website links. Fix any issues found."
                        ></textarea>

                        <div class="form-row">
                            <label>Max duration:</label>
                            <input type="number" class="timer-input" id="maxDuration" value="120" min="10" max="240">
                            <label>minutes</label>
                            <button class="btn btn-primary" id="startBtn" onclick="startTask()">Start Task</button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            Waiting for task input...
                        </div>
                    </div>

                    <div class="guardrails-info">
                        <h4>Guardrails Active</h4>
                        <ul>
                            <li>Cannot access Microsoft Teams</li>
                            <li>Cannot compose or send emails</li>
                            <li>Cannot access billing/payment pages</li>
                            <li>Can only read automation output emails</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let currentTask = null;
        let timerInterval = null;
        let taskStartTime = null;

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                addMessage('system', 'Connected to host controller');
            };

            ws.onclose = () => {
                addMessage('system', 'Disconnected. Reconnecting...');
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
        }

        function handleMessage(message) {
            const { type, payload } = message;

            switch (type) {
                case 'init':
                    updateVMStatus(payload.vmConnected);
                    if (payload.currentTask) {
                        setCurrentTask(payload.currentTask);
                    }
                    if (payload.latestScreenshot) {
                        updateScreenshot(payload.latestScreenshot);
                    }
                    break;

                case 'vm_status':
                    updateVMStatus(payload.connected);
                    break;

                case 'task_created':
                    setCurrentTask(payload.task);
                    addMessage('system', 'Task created. Waiting for plan...');
                    break;

                case 'plan_proposal':
                    showPlan(payload.plan);
                    break;

                case 'task_update':
                    if (payload.task) {
                        updateTaskStatus(payload.task);
                    }
                    if (payload.screenshot) {
                        updateScreenshot(payload.screenshot);
                    }
                    break;

                case 'task_complete':
                    handleTaskComplete(payload.task);
                    break;

                case 'screenshot':
                    updateScreenshot(payload.screenshot);
                    break;

                case 'error':
                    addMessage('system', `Error: ${payload.message}`);
                    break;
            }
        }

        function updateVMStatus(connected) {
            const dot = document.getElementById('vmStatus');
            const text = document.getElementById('vmStatusText');

            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'VM Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'VM Disconnected';
            }

            document.getElementById('startBtn').disabled = !connected;
        }

        function updateScreenshot(base64) {
            const preview = document.getElementById('vmPreview');
            preview.innerHTML = `<img src="data:image/png;base64,${base64}" alt="VM Screenshot">`;
        }

        function setCurrentTask(task) {
            currentTask = task;
            document.getElementById('taskStatus').style.display = 'block';
            document.getElementById('taskDescription').textContent = task.description;
            updateTaskStatus(task);

            if (task.status === 'running') {
                startTimer(task.startedAt, task.maxDurationMinutes);
            }
        }

        function updateTaskStatus(task) {
            document.getElementById('taskStatusBadge').textContent = task.status;
            document.getElementById('iterationCount').textContent = task.iterations || 0;
            document.getElementById('prsMerged').textContent = task.prsMerged || 0;

            if (task.messages && task.messages.length > 0) {
                const lastMsg = task.messages[task.messages.length - 1];
                addMessage('agent', lastMsg.message);
            }

            // Update progress
            if (task.startedAt && task.maxDurationMinutes) {
                const elapsed = (Date.now() - new Date(task.startedAt).getTime()) / 1000 / 60;
                const progress = Math.min((elapsed / task.maxDurationMinutes) * 100, 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
            }
        }

        function showPlan(plan) {
            document.getElementById('planSection').style.display = 'block';
            document.getElementById('planContent').textContent = plan;
            addMessage('agent', 'Here\'s my plan for this task. Please review and approve.');
        }

        function handleTaskComplete(task) {
            currentTask = null;
            stopTimer();

            const status = task.status === 'completed' ? 'completed successfully' : `ended with status: ${task.status}`;
            addMessage('system', `Task ${status}`);
            addMessage('agent', task.result || 'No result summary available.');

            document.getElementById('taskStatus').style.display = 'none';
            document.getElementById('planSection').style.display = 'none';
        }

        function startTask() {
            const description = document.getElementById('taskInput').value.trim();
            const maxDuration = parseInt(document.getElementById('maxDuration').value) || 120;

            if (!description) {
                alert('Please enter a task description');
                return;
            }

            ws.send(JSON.stringify({
                type: 'new_task',
                payload: {
                    description,
                    maxDurationMinutes: maxDuration,
                }
            }));

            addMessage('user', description);
            document.getElementById('taskInput').value = '';
        }

        function approvePlan() {
            const plan = document.getElementById('planContent').textContent;

            ws.send(JSON.stringify({
                type: 'approve_plan',
                payload: { plan }
            }));

            document.getElementById('planSection').style.display = 'none';
            addMessage('user', 'Plan approved. Starting execution...');

            if (currentTask) {
                startTimer(new Date().toISOString(), currentTask.maxDurationMinutes);
            }
        }

        function editPlan() {
            const plan = document.getElementById('planContent');
            plan.contentEditable = true;
            plan.focus();
            addMessage('system', 'Edit the plan above, then click Approve.');
        }

        function cancelTask() {
            if (confirm('Are you sure you want to cancel this task?')) {
                ws.send(JSON.stringify({
                    type: 'cancel_task',
                    payload: {}
                }));
            }
        }

        function requestScreenshot() {
            ws.send(JSON.stringify({
                type: 'request_screenshot',
                payload: {}
            }));
        }

        function addMessage(type, text) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();
            msg.appendChild(time);

            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function startTimer(startTime, maxMinutes) {
            taskStartTime = new Date(startTime);

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - taskStartTime.getTime()) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;

                document.getElementById('timerDisplay').textContent =
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                document.getElementById('elapsedTime').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // Update progress bar
                const progress = Math.min((elapsed / 60 / maxMinutes) * 100, 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Initialize
        connect();
    </script>
</body>
</html>
